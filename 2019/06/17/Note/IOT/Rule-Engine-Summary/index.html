<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?cb4be66237379541488b8502a6eca006"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    
    
    
    <title>(原创)本地规则引擎设计 | 大地小神 | 你们都是大傻瓜, 我是天下大赢家</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="IOT,Design">
    <meta name="description" content="dummy          code{white-space: pre-wrap;}       span.smallcaps{font-variant: small-caps;}       span.underline{text-decoration: underline;}       div.column{display: inline-block; vert">
<meta name="keywords" content="IOT,Design">
<meta property="og:type" content="article">
<meta property="og:title" content="(原创)本地规则引擎设计">
<meta property="og:url" content="https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/index.html">
<meta property="og:site_name" content="大地小神">
<meta property="og:description" content="dummy          code{white-space: pre-wrap;}       span.smallcaps{font-variant: small-caps;}       span.underline{text-decoration: underline;}       div.column{display: inline-block; vert">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_systeminfo.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_loglevel.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_logout.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_devicecontrol.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_rule_crud.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_rule_scene.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_gateway_list.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_gateway_add.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_device_discover.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_devicecontrol.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_rule_list.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_rule_edit.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_scene_list.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_scene_ms.png">
<meta property="og:updated_time" content="2019-06-24T15:12:29.178Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="(原创)本地规则引擎设计">
<meta name="twitter:description" content="dummy          code{white-space: pre-wrap;}       span.smallcaps{font-variant: small-caps;}       span.underline{text-decoration: underline;}       div.column{display: inline-block; vert">
<meta name="twitter:image" content="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_systeminfo.png">
    
        <link rel="alternate" type="application/atom+xml" title="大地小神" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">qrsforever</h5>
          <a href="mailto:985612771@qq.com" title="985612771@qq.com" class="mail">985612771@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/qrsforever" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://weibo.com/705723886/" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://zytforever.github.io" target="_blank" >
                <i class="icon icon-lg icon-eye"></i>
                Stocktech
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">(原创)本地规则引擎设计</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">(原创)本地规则引擎设计</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-06-17T07:59:42.000Z" itemprop="datePublished" class="page-time">
  2019-06-17
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Note/">Note</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#总体设计"><span class="post-toc-number">1.</span> <span class="post-toc-text">1 总体设计</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#日志系统"><span class="post-toc-number">2.</span> <span class="post-toc-text">2 日志系统</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#消息系统"><span class="post-toc-number">3.</span> <span class="post-toc-text">3 消息系统</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#引擎设计"><span class="post-toc-number">4.</span> <span class="post-toc-text">4 引擎设计</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#模型"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">4.1 模型</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#设备模型"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">4.1.1 设备模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#规则模型"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">4.1.2 规则模型</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#clp语言"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">4.2 CLP语言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#rulepayload设计"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">4.3 RulePayload设计</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#clp设计"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">4.4 CLP设计</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#引擎uml"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">4.5 引擎UML</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#httphandler"><span class="post-toc-number">5.</span> <span class="post-toc-text">5 HttpHandler</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#调试系统"><span class="post-toc-number">6.</span> <span class="post-toc-text">6 调试系统</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#系统监控python"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">6.1 系统监控(Python)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#规则配置js"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">6.2 规则配置(JS)</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-Note/IOT/Rule-Engine-Summary"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">(原创)本地规则引擎设计</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-06-17 15:59:42" datetime="2019-06-17T07:59:42.000Z"  itemprop="datePublished">2019-06-17</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Note/">Note</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>dummy</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
  </style>
  <link rel="stylesheet" href="/css/pandoc.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="#总体设计">总体设计</a></li>
<li><a href="#日志系统">日志系统</a></li>
<li><a href="#消息系统">消息系统</a></li>
<li><a href="#引擎设计">引擎设计</a>
<ul>
<li><a href="#模型">模型</a>
<ul>
<li><a href="#设备模型">设备模型</a></li>
<li><a href="#规则模型">规则模型</a></li>
</ul></li>
<li><a href="#clp语言">CLP语言</a></li>
<li><a href="#rulepayload设计">RulePayload设计</a></li>
<li><a href="#clp设计">CLP设计</a></li>
<li><a href="#引擎uml">引擎UML</a></li>
</ul></li>
<li><a href="#httphandler">HttpHandler</a></li>
<li><a href="#调试系统">调试系统</a>
<ul>
<li><a href="#系统监控python">系统监控(Python)</a></li>
<li><a href="#规则配置js">规则配置(JS)</a></li>
</ul></li>
</ul>
<!-- vim-markdown-toc -->
<a id="more"></a>
<h1 id="总体设计"><span class="header-section-number">1</span> 总体设计</h1>
<pre><code>  +----------------+         +-----------------+      +------------------+
  |                |         |                 |      |                  |
  |  elink cloud   |         |  debug monitor  |      |   debug webpage  |
  |                |         |    python       |      |       js         |
  |                |         |                 |      |                  |
  +----------------+         +-----------------+      +------------------+
             \                       |                                |
              \                      | tcp                            |
               \                     |                        restapi |
 +-----+        \                    v                                |      +-----+
 |     |   +----------------+    +---------+   +---------+            |      |     |
 |     |   |  gateway_agent |    | monitor |   |   clp   |            |      |     |
 |     |   |    (mqtt)      |    | (8192)  |   |         |            |      |     |
 |     |   +----------------+    +---------+   +---------+            |      |     |
 |     |                             |              |                 |      |     |
 |     |                             |              |                 |      |  m  |
 |     |                             v              v                 |      |  e  |
 |     |          +--------------------------------------+            |      |  s  |
 |     |          |                                      |            |      |  s  |
 |     |   +----&gt; |            rule engine               |            |      |  a  |
 |     |   |      |                                      |            |      |  g  |
 |     |   |      +--------------------------------------+            |      |  e  |
 |     |   |         |                 ^                              |      |     |
 |     |   |         |                 |                              |      |     |
 |     |   |         |                 |  message queue               |      |     |
 |     |   |         |                 |                              |      |     |
 |     |   |         |                 |                              |      |     |
 |     |   |         |    +---------------------------+               |      |     |
 |     |   |         |    |          payload          |               |      |     |
 | log |   |         |    |  -----------------------  |               |      |utils|
 |     |   |         |    | rule,class,instance,scene |               |      |     |
 |     |   |         |    +---------------------------+               |      |     |
 |     |   |         |                          ^                     |      |     |
 |     |   |         |                           \                    |      |     |
 |     |   |         |                            \                   |      |     |
 |     |   |         v                             \                  |      |     |
 |     |   |  +-----------------+            +---------------------+  |      |     |
 |     |   |  |     clipscpp    |            |     datachannel     |  |      |     |
 |     |   |  +-----------------+            | ------------------- |  |      |     |
 |     |   |  |   clips core    |            | device, cloud, app  |  |      |     |
 |     |   |  +-----------------+            +---------------------+  |      |     |
 |     |   |                                    ^            ^        |      |     |
 |     |   |                                   /              \       |      |     |
 |     |   |                                  /                \      |      |     |
 |     |   |                                 /                  \     v      |     |
 |     | +-----------------+        +----------------+  +---------------+    |     |
 |     | |    sql table    |        | device manager |  |  http handler |    |     |
 |     | |                 |        |       hu       |  |    (8899)     |    |     |
 |     | +-----------------+        +----------------+  +---------------+    |     |
 +-----+                              ^   ^    ^   ^                         +-----+
                  not                 |   |    |   |
             ----\--------------------+   |    |   +----------------------
            /             +---------------+    +-------------+            \
           /              |                                  |             \
 +--------------+         |      +---------------------+     |        +------------+
 |              |    ocf  |      |      ipc system     |     | ocf    |            |
 | dev profiles |         |      |        process      |     |        | ocf device |
 |              |   coap  |      +---------------------+     | coap   |            |
 +--------------+         |                 |                |        +------------+
                          |                 |                |
                 +----------------+         |         +--------------+
                 |  konke bridge  |   &lt;-----+-----&gt;   |  hue bridge  |
                 +----------------+    fork    fork   +--------------+
                         |                                     |
                         |  tcp                                |  alljoy
                         |                                     |
                 +---------------+                     +---------------+
                 | konke gateway |                     |  hue gateway  |
                 +---------------+                     +---------------+
                         |                                     |
                         |  zigbee                      unkown |
                         |                                     |
               *****************                           *********
         ******        sos      ******                  ***         ***
      ***  lightctrol          red    ***               *    light    *
      *              smartplug          *               ***         ***
      ***   scenectrol    envsonsor   ***                  *********
         ******                 ******
               *****************</code></pre>
<h1 id="日志系统"><span class="header-section-number">2</span> 日志系统</h1>
<p>规则引擎重要的一个功能就是将用户配置的规则文本转换为clp脚本, 而调试clp脚本需要好的工具 , 将clp脚本的调试日志输出到统一的日志系统中是必然要做的.</p>
<p>首先使用固定<code>buffer</code>作为日志缓冲, 即<code>ring buffer</code>, 所有模块均可往这buffer中写入, 日志 的最终输出采用多通道方式, 可以需要依次输出到终端, 文件或者网络.</p>
<pre><code>                                                                  +-----------------------+
        +-------------------+     +----------------+              |      RingBuffer       |
        |  MessageHandler   |     |    DataSink    |         ----&gt;|-----------------------|
        |-------------------|     |----------------|        /     |      mBufHead         |
        |  mMessageQueue    |     |   mRingBuffer  |-------/      |      mBufLength       |
        |  mMessageHandler  |     |   m_dataSize   | mRingBuffer  |-----------------------|
        |-------------------|     |----------------|              |  get[Write/Read]Head  |
        |   handleMessage   |     |  onDataArrive  |              |  submit[Write/Read]   |
        +-------------------+     +----------------+              +-----------------------+
                △                       △   ^
                |                       |   |
                +-----------+-----------+   +-------------------------------------------------------------------------------+
                            |                                                  +------------+                               |
                            |                                                  |            |                               |
                   +-----------------+                                         |            |                               |
         +-------&gt; |    LogPool      |                                         v            |                               |
         |         |-----------------|  mFilterHead                      +-----------+      |                               |
         |         |   mFilterHead   |◇ --------------------------------&gt;| LogFilter |      |                               |
         |         |-----------------|                                   |-----------|      |                               |
         |         |   attachFilter  |                                   |  m_next   |◇ ----+                               |
         |         |   detachFilter  |                                   |-----------|  m_next                              |
         |         |                 |                                   | pushBlock |                                      |
         |         |   onDataArrive  |                                   +-----------+                                      |
         |         |   receiveData   |                                     △   △   △                                        |
         |         |                 |                                     |   |   |                                        |
         |         |  handleMessage  |                                     |   |   |                                        |
         |         +-----------------+              +----------------------+   |   +-----------------------+                |
         |                                          |                          |                           |                |
         |                                          |                          |                           |                |
         |         +-----------+           +-----------------+        +----------------+          +-----------------+       |
         |         | LogThread |           |  ConsoleFilter  |        |   FileFilter   |          |  NetworkFilter  |       |
         |         |-----------|           |-----------------|        |----------------|          |-----------------|       |
         |         |           |           |                 |        |                |          |                 |       |
         | Create  |-----------|           |    pushBlock    |        |   pushBlock    |          |    pushBlock    |       |
         +---------|   run     |           +-----------------+        +----------------+          +-----------------+       |
                   +-----------+                                                                                            |
                         |                                                                                                  |
                         |                                                                                                  |
                         |                                                                                                  |
                         ▽                                                                                                  |
              +----------------------+                   +---------------+                                                  |
              |    MessageLooper     |                   |    Logger     |                                                  |
              |----------------------|                   |---------------|    mDataSink                                     |
              |       mMsgQueue      |                   |   mDataSink   |◇ ------------------------------------------------+
              |----------------------|                   |---------------|
              |        run           |                   |     log       |
              +----------------------+                   +---------------+
</code></pre>
<h1 id="消息系统"><span class="header-section-number">3</span> 消息系统</h1>
<p>消息系统是Homebrain主程序的血脉, 贯穿与整个引擎系统中. 也是程序设计中解耦合的重要方法.</p>
<pre><code>            +--------------------------------------------------------------------------------------------------+
            |                                                                                                  |
            |                                                                                                  |
            |                                                                       +-----------------+        |
            |                                                                       |     Message     |        |
            |                                                                    --&gt;|-----------------|        |
            |                                       +----------------+          /   |      what       |        |
            |                                       |  MessageQueue  |         /    |    arg[1|2|3]   | target |
            |                                 -----&gt;|----------------|        /     |     target      |◇ ------+
            |                                /      |    mMessages   |-------/      |-----------------|
            |                               /       |----------------| mMessage     |     obtain      |
            |                              /        | enqueueMessage |              |    recycle      |
            v                             /         |  removeMessage |              |      next       |
 +--------------------+                  /          |   nextMessage  |              +-----------------+
 |   MessageHandler   |                 /           +----------------+
 |--------------------| mMessageQueue  /
 |   mMessageQueue    |---------------/
 |   mMessageHandler  |◆ -----------------+
 |--------------------|  mMessageHandler  |
 |  dispatchMessage   |                   |                +------------+
 | sendMessage[Delay] |                   |        +-----▷ |   Thread   |
 |   handleMessage    |                   |        |       |------------|
 +--------------------+                   |        |       |    PID     |
           △                              |        |       |------------|
           |                              |        |       |    run     |
           |                              |        |       +------------+
           |                              v        |
 +-------------------+              +----------------------+
 | RuleEngineHandler |              | MessageHandlerThread |
 |-------------------|              |----------------------|
 |   handleMessage   |              |    mMessageQueue     |      +--------------------------------------+
 +-------------------+              |----------------------|      |while(true)                           |
                                    |        run           |-----&gt;|   msg = mMessageQueue-&gt;nextMessage() |
                                    +----------------------+      |   msg-&gt;target-&gt;dispatchMessage()     |
                                               △                  +--------------------------------------+
 +-------------------+                         |
 | RuleEngineThread  |                         |
 |-------------------|-------------------------+
 |                   |
 |-------------------|
 |       run         |
 +-------------------+
</code></pre>
<h1 id="引擎设计"><span class="header-section-number">4</span> 引擎设计</h1>
<p>采用专家系统工具Clips进行前向推导, clips是工具也是一种语言, 提供c接口, 同时也支持脚本 独立运行, 所以规则引擎的设计其实就转变为clips脚本设计.</p>
<h2 id="模型"><span class="header-section-number">4.1</span> 模型</h2>
<h3 id="设备模型"><span class="header-section-number">4.1.1</span> 设备模型</h3>
<div class="sourceCode" id="cb4" data-startfrom="1"><pre class="sourceCode numberSource json numberLines"><code class="sourceCode json"><a class="sourceLine" id="cb4-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb4-2" title="2">    <span class="dt">&quot;devicetype&quot;</span><span class="fu">:</span> <span class="st">&quot;oic.d.hue_bri_light&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="dt">&quot;supertype&quot;</span><span class="fu">:</span> <span class="st">&quot;oic.d.light&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="dt">&quot;devicename&quot;</span><span class="fu">:</span> <span class="st">&quot;飞利浦灯&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="dt">&quot;manufacture&quot;</span><span class="fu">:</span> <span class="st">&quot;Philips&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="dt">&quot;iconid&quot;</span><span class="fu">:</span> <span class="st">&quot;ic_default_light&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.9.2&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="dt">&quot;profile&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">        <span class="dt">&quot;OnlineState&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-10" title="10">            <span class="dt">&quot;tag&quot;</span><span class="fu">:</span> <span class="st">&quot;在线状态&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-11" title="11">            <span class="dt">&quot;write&quot;</span><span class="fu">:</span> <span class="st">&quot;F&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-12" title="12">            <span class="dt">&quot;read&quot;</span><span class="fu">:</span> <span class="st">&quot;T&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-13" title="13">            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;enum&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-14" title="14">            <span class="dt">&quot;range&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-15" title="15">                <span class="dt">&quot;0&quot;</span><span class="fu">:</span> <span class="st">&quot;离线&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-16" title="16">                <span class="dt">&quot;1&quot;</span><span class="fu">:</span> <span class="st">&quot;在线&quot;</span></a>
<a class="sourceLine" id="cb4-17" title="17">            <span class="fu">}</span></a>
<a class="sourceLine" id="cb4-18" title="18">        <span class="fu">},</span></a>
<a class="sourceLine" id="cb4-19" title="19">        <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-20" title="20">            <span class="dt">&quot;rt&quot;</span><span class="fu">:</span> <span class="st">&quot;oic.r.switch.binary&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-21" title="21">            <span class="dt">&quot;iconid&quot;</span><span class="fu">:</span> <span class="st">&quot;ic_default_switch&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-22" title="22">            <span class="dt">&quot;tag&quot;</span><span class="fu">:</span> <span class="st">&quot;开关&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-23" title="23">            <span class="dt">&quot;read&quot;</span><span class="fu">:</span> <span class="st">&quot;T&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-24" title="24">            <span class="dt">&quot;write&quot;</span><span class="fu">:</span> <span class="st">&quot;T&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-25" title="25">            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;enum&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-26" title="26">            <span class="dt">&quot;range&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-27" title="27">                <span class="dt">&quot;0&quot;</span><span class="fu">:</span> <span class="st">&quot;关闭&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-28" title="28">                <span class="dt">&quot;1&quot;</span><span class="fu">:</span> <span class="st">&quot;开启&quot;</span></a>
<a class="sourceLine" id="cb4-29" title="29">            <span class="fu">},</span></a>
<a class="sourceLine" id="cb4-30" title="30">            <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb4-31" title="31">        <span class="fu">},</span></a>
<a class="sourceLine" id="cb4-32" title="32">        <span class="dt">&quot;brightness&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-33" title="33">            <span class="dt">&quot;rt&quot;</span><span class="fu">:</span> <span class="st">&quot;oic.r.light.brightness&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-34" title="34">            <span class="dt">&quot;tag&quot;</span><span class="fu">:</span> <span class="st">&quot;亮度&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-35" title="35">            <span class="dt">&quot;read&quot;</span><span class="fu">:</span> <span class="st">&quot;T&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-36" title="36">            <span class="dt">&quot;write&quot;</span><span class="fu">:</span> <span class="st">&quot;T&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-37" title="37">            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;int&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-38" title="38">            <span class="dt">&quot;range&quot;</span><span class="fu">:</span> <span class="st">&quot;v &gt;= 0 and v &lt;= 100&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-39" title="39">            <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb4-40" title="40">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb4-41" title="41">    <span class="fu">}</span></a>
<a class="sourceLine" id="cb4-42" title="42"><span class="fu">}</span></a></code></pre></div>
<h3 id="规则模型"><span class="header-section-number">4.1.2</span> 规则模型</h3>
<div class="sourceCode" id="cb5" data-startfrom="1"><pre class="sourceCode numberSource json numberLines"><code class="sourceCode json"><a class="sourceLine" id="cb5-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="dt">&quot;ruleName&quot;</span><span class="fu">:</span><span class="st">&quot;example&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="dt">&quot;ruleId&quot;</span><span class="fu">:</span><span class="st">&quot;123456&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">&quot;description&quot;</span><span class="fu">:</span><span class="st">&quot;this is a example for rule definition&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">&quot;trigger&quot;</span><span class="fu">:{</span></a>
<a class="sourceLine" id="cb5-6" title="6">        <span class="dt">&quot;triggerType&quot;</span><span class="fu">:</span><span class="st">&quot;auto|manual&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-7" title="7">        <span class="dt">&quot;switch&quot;</span><span class="fu">:{</span></a>
<a class="sourceLine" id="cb5-8" title="8">            <span class="dt">&quot;enabled&quot;</span><span class="fu">:</span><span class="st">&quot;on&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-9" title="9">            <span class="dt">&quot;timeCondition&quot;</span><span class="fu">:</span><span class="st">&quot;on&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-10" title="10">            <span class="dt">&quot;deviceCondition &quot;</span><span class="fu">:</span><span class="st">&quot;on&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-11" title="11">            <span class="dt">&quot;notify&quot;</span><span class="fu">:</span><span class="st">&quot;on&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-12" title="12">            <span class="dt">&quot;manual&quot;</span><span class="fu">:</span><span class="st">&quot;on&quot;</span></a>
<a class="sourceLine" id="cb5-13" title="13">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="fu">},</span></a>
<a class="sourceLine" id="cb5-15" title="15">    <span class="dt">&quot;conditions&quot;</span><span class="fu">:{</span></a>
<a class="sourceLine" id="cb5-16" title="16">        <span class="dt">&quot;conditionLogic&quot;</span><span class="fu">:</span><span class="st">&quot;and&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-17" title="17">        <span class="dt">&quot;timeCondition&quot;</span><span class="fu">:</span><span class="ot">[</span></a>
<a class="sourceLine" id="cb5-18" title="18">        <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-19" title="19">            <span class="dt">&quot;year&quot;</span><span class="fu">:</span><span class="st">&quot;2018&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-20" title="20">            <span class="dt">&quot;month&quot;</span><span class="fu">:</span><span class="st">&quot;10&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-21" title="21">            <span class="dt">&quot;day&quot;</span><span class="fu">:</span><span class="st">&quot;10|13|17&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-22" title="22">            <span class="dt">&quot;hour&quot;</span><span class="fu">:</span><span class="st">&quot;every&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-23" title="23">            <span class="dt">&quot;minute&quot;</span><span class="fu">:</span><span class="st">&quot;every&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-24" title="24">            <span class="dt">&quot;second&quot;</span><span class="fu">:</span><span class="st">&quot;1&quot;</span></a>
<a class="sourceLine" id="cb5-25" title="25">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb5-26" title="26">        <span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-27" title="27">        <span class="dt">&quot;deviceCondition&quot;</span><span class="fu">:{</span></a>
<a class="sourceLine" id="cb5-28" title="28">            <span class="dt">&quot;deviceLogic&quot;</span><span class="fu">:</span><span class="st">&quot;or&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-29" title="29">            <span class="dt">&quot;deviceStatus&quot;</span><span class="fu">:</span><span class="ot">[</span></a>
<a class="sourceLine" id="cb5-30" title="30">            <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-31" title="31">                <span class="dt">&quot;deviceId&quot;</span><span class="fu">:</span><span class="st">&quot;0007A895C8A7&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-32" title="32">                <span class="dt">&quot;propName&quot;</span><span class="fu">:</span><span class="st">&quot;CurrentTemperature&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-33" title="33">                <span class="dt">&quot;propValue&quot;</span><span class="fu">:</span><span class="st">&quot;v&gt;50&quot;</span></a>
<a class="sourceLine" id="cb5-34" title="34">            <span class="fu">}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb5-35" title="35">            <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-36" title="36">                <span class="dt">&quot;deviceId&quot;</span><span class="fu">:</span><span class="st">&quot;DC330D799327&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-37" title="37">                <span class="dt">&quot;propName&quot;</span><span class="fu">:</span><span class="st">&quot;onOffLight&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-38" title="38">                <span class="dt">&quot;propValue&quot;</span><span class="fu">:</span><span class="st">&quot;v==true&quot;</span></a>
<a class="sourceLine" id="cb5-39" title="39">            <span class="fu">}</span></a>
<a class="sourceLine" id="cb5-40" title="40">            <span class="ot">]</span></a>
<a class="sourceLine" id="cb5-41" title="41">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb5-42" title="42">    <span class="fu">},</span></a>
<a class="sourceLine" id="cb5-43" title="43">    <span class="dt">&quot;actions&quot;</span><span class="fu">:{</span></a>
<a class="sourceLine" id="cb5-44" title="44">        <span class="dt">&quot;execScene&quot;</span><span class="fu">:</span><span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-45" title="45">        <span class="dt">&quot;notify&quot;</span><span class="fu">:{</span></a>
<a class="sourceLine" id="cb5-46" title="46">            <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;xxx&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-47" title="47">            <span class="dt">&quot;message&quot;</span><span class="fu">:</span><span class="st">&quot;Girlfriend Birthday!&quot;</span></a>
<a class="sourceLine" id="cb5-48" title="48">        <span class="fu">},</span></a>
<a class="sourceLine" id="cb5-49" title="49">        <span class="dt">&quot;deviceControl&quot;</span><span class="fu">:</span><span class="ot">[</span></a>
<a class="sourceLine" id="cb5-50" title="50">        <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-51" title="51">            <span class="dt">&quot;deviceId&quot;</span><span class="fu">:</span><span class="st">&quot;0007A895C7C7&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-52" title="52">            <span class="dt">&quot;propName&quot;</span><span class="fu">:</span><span class="st">&quot;CurrentTemperature&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-53" title="53">            <span class="dt">&quot;propValue&quot;</span><span class="fu">:</span><span class="st">&quot;50&quot;</span></a>
<a class="sourceLine" id="cb5-54" title="54">        <span class="fu">}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb5-55" title="55">        <span class="fu">{</span></a>
<a class="sourceLine" id="cb5-56" title="56">            <span class="dt">&quot;deviceId&quot;</span><span class="fu">:</span><span class="st">&quot;DC330D79932A&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-57" title="57">            <span class="dt">&quot;propName&quot;</span><span class="fu">:</span><span class="st">&quot;onOffLight&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-58" title="58">            <span class="dt">&quot;propValue&quot;</span><span class="fu">:</span><span class="st">&quot;true&quot;</span></a>
<a class="sourceLine" id="cb5-59" title="59">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb5-60" title="60">        <span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-61" title="61">        <span class="dt">&quot;manualRuleId&quot;</span><span class="fu">:</span><span class="ot">[</span></a>
<a class="sourceLine" id="cb5-62" title="62">            <span class="st">&quot;1528374365.417.48775&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb5-63" title="63">            <span class="st">&quot;1528424679.929.67961&quot;</span></a>
<a class="sourceLine" id="cb5-64" title="64">        <span class="ot">]</span></a>
<a class="sourceLine" id="cb5-65" title="65">    <span class="fu">}</span></a>
<a class="sourceLine" id="cb5-66" title="66"><span class="fu">}</span></a></code></pre></div>
<h2 id="clp语言"><span class="header-section-number">4.2</span> CLP语言</h2>
<pre><code>                              ruleID
                                ^                   -----&gt; comment, here we want is rule name.
                                |                  /
                                |                 /                    -----&gt; MultiSlot
                  (defrule rul-0001 &quot;this is an example&quot;              /
        +--------   (and                                             /
        |             (and                   -------------------------------------------------------
        |               ?fct_t1 &lt;- (datetime ?clock ?year ?month ?day ?hour ?minute ?second $?others) ---+
        |      1        (test (= ?year 2018))                                                            |  Condition: Fact
        |    layer      (test (= ?month 06))                                                             | (not use Template)
        |               (test (or (= ?day 20) (= ?day 21) (= ?day 22) ))                              ---+
        |             )                                    -----------\
        |             (or                                              \------&gt; Cell
LHSNode |               (object (is-a TempSensor)                                                     ---+
        |                 (ID ?id &amp;:(eq ?id ins-0007A895C8A7))                                           |
        |      2          (CurrentTemperature ?CurrentTemperature &amp;:(&gt; ?CurrentTemperature 50))          |
        |    layer      )                                                                                |
        |               (object (is-a Light)                                                             | Condition: Instance
        |                 (ID ?id &amp;:(eq ?id ins-DC330D799327))          /-----&gt; Cell                     |
        |                 (onOffLight ?onOffLight &amp;:(= ?onOffLight 1)) /                                 |
        |               )       \                   -------------------                               ---+
        |             )          \                           +--&gt; timeout-ms
        +--------   )             --------&gt; SlotPoint        |  +--&gt; retry-count
                   =&gt;                                        |  |
        +--------   (bind ?c (create-rule-context rul-0001 5000 5))   ------&gt; create the rule context
        |           (if (eq ?c FALSE) then (return))
        |           (send ?c act-control ins-0007A895C7C7 CurrentTemperature 50)   ---&gt; action: device control
RHSNode |           (send ?c act-control ins-DC330D79932A onOffLight 1)
        |           (send ?c act-notify 10000001 &quot;tellYou&quot; &quot;Girlfriend Birthday&quot;)  ---&gt; action: message notify
        |           (switch-scene room1 commehome)                                 ---&gt; action: switch scene
        +---------  (send ?c act-scene rul-1000)                                   ---&gt; action: active manual rule
                  )

------------------------------------------------------------------------------------------------------------------------------

                                                     /---&gt; DEVICE is superclass
          + --------------  (defclass SmogAlarm     /
          |                   (is-a DEVICE) -------/
          |             /---- (role concrete) (pattern-match reactive) ----&gt; can triggered by rule
  Class   |            v      (slot OnlineState (type NUMBER) (allowed-numbers 2 1))
          | (not abstract)    (slot PowerOnOff (type INTEGER) (allowed-numbers 2 1))
          |                   (slot SecurityLevel (type SYMBOL) (allowed-symbols low normal high))
          |                   (slot Battery (type NUMBER) (allowed-numbers 2 1))
          +---------------- )                        /
                                                    /
                                                   v
                                          (INTEGER or FLOAT)</code></pre>
<h2 id="rulepayload设计"><span class="header-section-number">4.3</span> RulePayload设计</h2>
<pre><code>LHSNode Tree

                                              *********          &quot;and&quot;: condition logic
                                           *** LHSNode  **
                                           *             *
                                           ***  &quot;and&quot;  ***
                                         /    *********    \
                                        /         |         \
                             child     /          |          \   child
                                      /      cond |           \
                                     /            |            \
                                    /             |             \
                                   /              |              \
                                  /               |               \
                                 /                |                \
                      *********            +-------------+            *********
                   *** LHSNode ***         |  Condition  |         *** LHSNode ***
                   *             *         |             |         *             *
                   ***  &quot;or&quot;   ***         |    &quot;and&quot;    |         ***   &quot;or&quot;  ***
                   /  *********  \         +-------------+            *********
                  /               \
                 /                 \            &quot;and&quot;: slot logic, only support &quot;and&quot;
                / cond         cond \
               /                     \                                                +---------------------------+
              /                       \                                               |          +------+         |
      +-------------+           +-------------+                                       |          |      |         |
      |  Condition  |           |  Condition  |                                     Fact    Instance    |         |
      |             |           |             |                                       \        /        |         |
      |   &quot;and&quot;     |           |    &quot;and&quot;    |                                        \ type /         |         |
      +-------------+           +-------------+                                         \    /          v         v
                                       |                                               Condition &lt;---&gt; Device | TimeEvent
                                       |                                               SlotPoint &lt;---&gt; Property
                                       |
                -----------+-----------+-----------+---------------
                           |                       |
                           |                       |
                           v                       v
                    +-------------+         +-------------+     &quot;&amp;&quot;: cell logic
                    |  SlotPoint  |         |  SlotPoint  |     &quot;|&quot;: cell logic
                    |             |         |             |     &quot;~&quot;
                    |    &quot;&amp;&quot;      |         |     &quot;|&quot;     |
                    +-------------+         +-------------+
                           |                       |
                           |                       |
                           v                       v
                 +-------------------+    +-------------------+
                 |       Cell        |    |       Cell        |    Compare Symbol: &quot;=, &gt;, &lt;, &gt;=, &lt;=, &lt;&gt;&quot;
                 |                   |    |                   |    Connective Symbol: &quot;&amp;, |, ~&quot;
                 |(v &gt; 10) &amp; (v &lt; 20)|    |(v = 10) | (v &gt; 20)|
                 +-------------------+    +-------------------+
</code></pre>
<h2 id="clp设计"><span class="header-section-number">4.4</span> CLP设计</h2>
<pre><code>                                                                  (auto)     (manual)
                                          device                 property
                      profile  rule   online offline             changed      scene
               TestCase ---------------------------------------------------------------------------------------------------&gt;
                         |       |       |      |        ║          |           |
                         |       |       |      |    mainHandler    |           |
            mainHander() |       |       |      |        ║          |           |
                v        v       v       v      v        ▼          v           v
   MainThread -------------------------------------------------------------------------------------------------------------&gt;
                 \    profile  rule      \      \          ║        \           \
                  \      json    json     \      \     ruleHandler   \           \
                   \        \      \       |      |        ║          |           |
                    \        \      \      |      |        ▼          |           |
                     \        \      \     v  T   v     T         T   v     T     v   T         T         T         T
      RuleThread     --------------+----------+---------+---------+---+-----+---------+---------+---------+---------+-----&gt;
                      ^            T      add |  del    |         |   \     |     /   |         |         |         |
                  ruleHander()     |          |         |         |    \    |    /    |         |         |         |
                                   |          |         |         |     |   |   |     |         |         |         |
                                   +--\       +--\      +--\      +--\  v   v   v  /--+      /--+      /--+      /--+
                                       \          \         \         \+---------+/         /         /         /
 T: timer (default 1s)                  \          \         \         | refresh |         /         /         /
                                         -----------------------------&gt;|         |&lt;----------------------------
                                                                       |   run   |
                                                                       +---------+
                                                                            |               +--------+
                (LHS)                                                       |         ----▷ |  USER  |
             +--------------------------------------------------------------+        /      +--------+
   salience  |                                                                      /            △
             |                        +-------------------+                        /             |
             v                        |   RuleContext     |                       /              |
        +--------+                    |-------------------|                      /              /
    +---| Rule-1 |                    |   rule-id         |                     /              /
    |   +--------+                    |   timeout-ms      |           +---------+       +-----------+        +----------------+
    |                                 |   retry-count     |---------▷ | Context |       |  DEVICE   |        |  SmogAlarm     |
    +-&gt; +--------+                    |   current-try     |           |         |       |-----------|        |----------------|
    +---| Rule-2 |                    |   start-time      |           +---------+       |   ID      |◁ ------|   OnlineState  |
    |   +--------+                    |   act-error       |                             |   UUID    |        |   PowerOnOff   |
    |                                 |   unanswer-list   |                             |   Class   |        |   Battery      |
    +-&gt; +--------+                    |   response-rules  |                             +-----------+        +----------------+
    +---| Rule-3 |                    |-------------------|
    |   +--------+                    |   try-again       |
    |                                 |   unanswer-count  |
    +-&gt; +--------+                    |   act-control     |
        | Rule-4 |                    |   act-notify      |
        +--------+                    |   act-scene       |
            |                         +-------------------+
            |                                      +-------------------------+----------------------+------------+
            |                                      |                         |                      |            |
            |          Action                      |                         |                      |            v
            +--------------------------&gt;  act-control ------------&gt; act-notify -----------&gt; act-scene   |   send-message
            |  (RHS)                          |  ^                      |   ^                   /       |        |
            |               act-step-control  |  | true                 |   | true             /        |        | success
            |                                 |  |                      |   |                 v                  |   or
            |                                 |  +------&gt;  make-rule    |   +------&gt;  make-rule                  |  fail
            |                                 |  | false  (response)    |   | false  (response)                  |
            |                                 v  |                      v   |                                    v
            |    RuleEngineService  --------------------------------------------------------------------------------------&gt;
            |       ( HB )                   ins-push                   txt-push                              msg-push
            |                                ^    ^
            |                                |    |               services
            |                                |    |             +--------------------------------------------------+
    Action  +------&gt; onEnter ----------------+    |             |                                                  |
            |                             ^       |             ◇                                                  |
            |                             |       |     +-------------------+                                      v
            +------&gt; onExit --------------+-------+     |   SceneContext    |                              +----------------+
            |                  ^          |             | ----------------- |                              |  (MS)service   |
            |                  |          |             |     stime         |                              |--------------- |
            |                  |          |             |     where         |   +--&gt; enter     start &lt;--+  |     master     |
            v                  |           \            |     target        |   |                       |  |    name:skey   |
       micro service           |            \           |     action        ----+--&gt; story   running &lt;--+---     state      |
        (onStory)              |             \          |     services      |   |                       |  |     ntime      |
            |                  |              \         |     zombies       |   +--&gt; exit       stop &lt;--+  |     saves      |
            |                  |               \        |-------------------|                              |      args      |
    +-------+------+           |                \       |    add-service    |                              |                |
    |              |           |                 \      |    del-service    |                              +----------------+
    v              v           |                 |      +-------------------+
gradligth       autolight      |2              3 |
                               |                 |
        ^     ^                |                 |
        |     |                |                 |
        |     |  1   +-----------+  swtich    +----------+
        |     +------| gotosleep | ---------&gt; |  wakeup  |
        |   stop     +-----------+    to      +----------+
        |                                             |
        | start                            4          |
        +---------------------------------------------+</code></pre>
<h2 id="引擎uml"><span class="header-section-number">4.5</span> 引擎UML</h2>
<pre><code>                                          +---------------+
 +--------------+                         |   Condition   |                 +------------+               +----------+
 |    Action    |                         |---------------|                 | SlotPoint  |               |  _Cell_  |
 |--------------|                         |   mSlotLogic  |          -----&gt; |------------|        ------&gt;|----------|
 |  mType       |                         |    mType      |         /       | mCellLogic |       /       | nSymbol  |
 |  mCall       | ^                       |    mCls       |        /        | mSlotName  |      /        | nValue   |
 |  mID         |  \                      |    mID        |       /         | mCells     |◆ ---/mCells   +----------+
 |  mSlotName   |   \                     |   mSlots      |◆ ----/mSlots    +------------+
 |  mSlotValue  |    -------+             +---------------+
 +--------------+    1:n    | mActions       ^                  +-----------+     mCondLogic: and/or/not
                            |                |                  |           |     mSlotLogic: and             +------------+
                          +------------+     |          +--------------+    |     mCellLogic: &amp;,|,~           |  SlotInfo  |
                          |  RHSNode   |     |          |   LHSNode    |    |     nSymbol: =,&gt;,&lt;,&gt;=,&lt;=,&lt;&gt;     |------------|
                          | -----------|     |          |--------------|    |                                 |   nName    |
                          |  mActions  |     |          |  mCondLogic  |   /mChildren                         |   nValue   |
                          +------------+     +--------◇ |  mConditions |  /                                   +------------+
                                   ^         mConditions|  mChildren   |-/  +---------------+                         ^
                                   |                    +--------------+    |  RulePayload  |                  mSlots |  1:n
                                   +----------\                ^            |---------------|                         |
                                               \               |            |  mRuleName    |                         ◆
                              +-------------+   \              |            |  mRuleID      |            +-------------------+
                              | DataChannel |    \             |     mLHS   |  mVersion     |            |  InstancePayload  |
                              |-------------|     \            +----------◇ |  mLHS         |            |-------------------|
                              |             |      -----------------------◇ |  mRHS         |         /--|      mInsName     |
                              |send(payload)|                        mLHS   |---------------|        /   |      mClsName     |
                              +-------------+                               |  toString()   |       /    |      mSlots       |
                                  △ ^ ^ △                                   +---------------+      /     +-------------------+
                                  | | | |                                             |           /
                                  | | | |                                             |          |
                  +---------------+ | | +----------------+                            |          |
                  |                 | |                  |                            |          |
                  |                 | |                  |                            ▽          |
         +------------------+       | |     +--------------------------+        +----------+ ◁ --+          +-----------------+
         | RuleDataChannel  |       | |     |    DeviceDataChannel     |        | Payload  |                |  ClassPayload   |
mCloudMgr|------------------|       | |     | ------------------------ |        |----------| ◁ -------------|-----------------|
  +----◆ |    mCloudMgr     |       | |     |       mDeviceMgr         |        |  type()  |                |   classname     |
  |      |    mHandler      |       | |     |       mHandler           |        +----------+                |   superclass    |
  |      +------------------+       | |     |--------------------------|             |             mSlots   |   version       |
  |               △                 | |     |    onStateChanged()      |             |                +---◇ |    mSlots       |
  |               |                 | |     |    onPropertyChanged()   |-------------+            1:n |     |-----------------|
  |               |                 | |     |         send()           |                              |     |   toString()    |
  |    +------------------------+   | |     +--------------------------+◆ ---------------------+      |     +-----------------+
  |    |  ElinkRuleDataChannel  |   | |                △          ◆        mHandler            |      |
  |    |------------------------|   | |                |          |                            |      |
  |    |                        |   | |                |          +----------+                 |      |
  |    |      onRuleSync()      |   | |   +-------------------------+        |                 |      |     +---------------+
  |    |        send()          |   | |   | ElinkDeviceDataChannel  |        |                 |      |     |     Slot      |
  |    +------------------------+   | |   |-------------------------|        |                 |      +---&gt; |---------------|
  |                                 | |   |      onProfileSync()    |        |                 |            |    mType      |
  |                                 | |   +-------------------------+        |                 |            |    mName      |
  |                                 | |                                      |                 |            |   mMin/mMax   |
  |    +-------------------------+  | |                           mDeviceMgr |                 |            |   mAllowList  |
  |    |     CloudManager        |  | |                                      v                 |            |---------------|
  |    |-------------------------|  | |   +----------------------------------------+           |            |   toString()  |
  +---&gt;|                         |  | |   |             DeviceManger               |           |            +---------------+
       | registRuleSyncCallback  |  | |   | -------------------------------------- |           |
       |                         |  | |   |                                        |           |
       +-------------------------+  | |   |   registDeviceStateChangedCallback     |           |
                                    | |   |   registDevicePropertyChangedCallback  |           |
                                    | |   |   registDeviceProfileSyncCallback      |           |
+-----------------------------------+ |   |        setProperty                     |           |
| +-----------------------------------+   +----------------------------------------+           |
| |                                                                                            |
| |                    +----------------------------+        +----------------+                |
| |             +----▷ |  MessageHandler::Callback  | &lt;----◇ | MessageHandler | ◁ ---------+   |
| |             |      +----------------------------+        |----------------|            |   |
| |             |                                            |   mCallback    |            |   |
| |             |                                            +----------------+            |   |
| |  +----------------------+                                                              |   |
| |  |  RuleEngineService   |                                                              |   v
| |  |----------------------|   mUrgentHandler                                    +--------------------+
| |  |     mUrgentHandler   |◇ --------------------------------------------------&gt;|  RuleEventHandler  |
| |  |                      |    mCore         +----------------------+    ------&gt;|--------------------|
| |  |  mCore/mCoreUrgent   | ◆ -------------&gt; |    RuleEngineCore    |   /       |    handleMessage   |
| |  |     mServerRoot      |                  |----------------------|  /        +--------------------+
| +--|     mDeviceChannel   |          mEnv    |    mHandler          | /mHandler           |
+----|     mRuleChannel     |        +-------◆ |    mEnv              |◆                    |
     | mOfflineInsesCalled  |        |         |----------------------|                     |
     |----------------------|        |         |    driver()          |                     |
     |    callInstancePush  |        |         |                      |            +------------------+
     |    callMessagePush   |        |         |   handleTimer        |            | RuleEventThread  |
     |    setDeviceChannel  |        |         |   handleClassSync    |            |------------------|
     |    setRuleChannel    |        |         |   handleRuleSync     |            |   mMessageQueue  |
     |     handleMessage    |        |         |   handleInstanceAdd  |            +------------------+
     +----------------------+        |         |   handleInstanceDel  |                     △
                                     v         |   handleInstancePut  |                     |
                           +---------------+   +----------------------+                     |
                           |  Environment  |                                                |
                           |               |--\                                   +---------------------+
                           +---------------+   \  CLP                             |   RuleUrgentThread  |
                            Clipscpp            ------&gt; clips6.30                 |---------------------|
                                                                                  |     mService        |
                                                                                  +---------------------+
                            +----------------------+
                            |     HBDatabase       |
                            |  (template class)    |
           /--------------◆ |----------------------|
          /        mDB      | mAutoCloseInterval   |
         /                  | mDBPath   mMutex     |
        |                   |----------------------|
        |                   |   updateOrInsert     |
        v                   |   deleteBy           |                       +--------------------+
+--------------+            |   queryBy            |                       | DeviceProfileTable |
|SQLiteDatabase|            |                      |                       |                    |
|              |            +----------------------+                       +--------------------+
|              |                    |                                               |
+--------------+                    |                                               |
        ^                        mainDB()              +---------------------+      |      +------------------+
        |                                              | GatewayConnectTable |      |      |  OCFDeviceTable  |
        | mDB                                          |                     |      |      |                  |
        |                                              +---------------------+      |      +------------------+
        ◆                                                        |                  |               |
 +------------------+                                            |                  |               |
 |   SQLiteTable    | ◁ ------------------------------------------------------------+---------------+
 |------------------|                      |                              |                         |
 |                  |                      |                              |                         |
 |                  |              +-----------------+          +------------------+         +-----------------+
 +------------------+              | RuleEngineTable |          | SceneEngineTable |         |  HBGlobalTable  |
                                   |                 |          |                  |         |                 |
                                   +-----------------+          +------------------+         +-----------------+</code></pre>
<h1 id="httphandler"><span class="header-section-number">5</span> HttpHandler</h1>
<p>自行百度craw, 一个非常快速和易于使用的C++微型web框架.</p>
<h1 id="调试系统"><span class="header-section-number">6</span> 调试系统</h1>
<h2 id="系统监控python"><span class="header-section-number">6.1</span> 系统监控(Python)</h2>
<p>python写的monitor工具, 设计了很多调试规则的选项, 具体功能:</p>
<ul>
<li>显示系统信息</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_systeminfo.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>设置各模块的日志级别, 配置调试clp的各个变量信息等</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_loglevel.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>将日志输出到monitor端,可以进行过滤, 可配置rule的调试选项等</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_logout.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>显示当前系统的中的所有设备实例, 根据类型可以查询, 设置设备属性, 或直接设置到引擎中.</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_devicecontrol.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>新建,查看,编辑,删除规则(只有查看功能有效, 其他功能已屏蔽, 可以使用webpage完成操作).</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_rule_crud.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>执行一些定义好的模式, 或者直接发送"事实"触发规则</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/monitor_rule_scene.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<h2 id="规则配置js"><span class="header-section-number">6.2</span> 规则配置(JS)</h2>
<p>基于restapi实现规则的配置与执行, 具体功能:</p>
<ul>
<li>网关(桥:hue, konke)配置管理</li>
</ul>
<p>网关(桥)列表:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_gateway_list.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<p>添加新的网关:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_gateway_add.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>设备的发现及控制管理</li>
</ul>
<p>设备发现:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_device_discover.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<p>设备列表及控制:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_devicecontrol.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>规则的编辑及管理</li>
</ul>
<p>规则列表:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_rule_list.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<p>规则配置:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_rule_edit.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>场景的编辑及管理</li>
</ul>
<p>场景列表:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_scene_list.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<p>场景微服务配置:</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/qrsforever/asset_blog_post/master/Note/IOT/www_scene_ms.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
</body>
</html>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-06-24T15:12:29.178Z" itemprop="dateUpdated">2019-06-24 23:12:29</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://qrsforever.github.io">
            <img src="/img/avatar.jpg" alt="qrsforever">
            qrsforever
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Design/">Design</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IOT/">IOT</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/&title=《(原创)本地规则引擎设计》 — 大地小神&pic=https://qrsforever.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/&title=《(原创)本地规则引擎设计》 — 大地小神&source=


  
  
  
  dummy
  
      code{white-space: pre-wrap;}
      span.smallcap..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《(原创)本地规则引擎设计》 — 大地小神&url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/&via=https://qrsforever.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/06/23/ML/Guide/cross_entropy_loss/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">(原创)交叉熵损失函数</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/06/14/ML/Scratch/convolution_plot/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">(原创)用数据模拟卷积-初探</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <!-- <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->
    <script src="/js/av-min.js"></script>
    <script src="/js/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'false' == 'true',
            verify: 'false' == 'true',
            appId: "bpShGWdW8DpODhnDko5O2IBB-gzGzoHsz",
            appKey: "rwmasTllBbHE69ADuLjFyFWf",
            avatar: "mm",
            placeholder: "Just go go",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->










</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢打赏!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>qrsforever &copy; 2017 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/&title=《(原创)本地规则引擎设计》 — 大地小神&pic=https://qrsforever.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/&title=《(原创)本地规则引擎设计》 — 大地小神&source=


  
  
  
  dummy
  
      code{white-space: pre-wrap;}
      span.smallcap..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《(原创)本地规则引擎设计》 — 大地小神&url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/&via=https://qrsforever.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://qrsforever.github.io/2019/06/17/Note/IOT/Rule-Engine-Summary/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!-- lidong cha. -->
<!-- <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<!-- lidong end. -->

</body>
</html>
